<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Cities</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <a href="index.html" class="back-link">← Back to Tools</a>
            <img src="https://www.datocms-assets.com/19381/1652271729-adtrak-2.png" alt="Adtrak Logo" class="logo">
            <div id="city-list"></div>
            <div id="diameter-control" style="display: none;">
                <label for="diameter-input">Circle Diameter (miles):</label>
                <div class="diameter-input-group">
                    <input type="number" id="diameter-input" min="1" max="500" value="30">
                    <button id="apply-diameter-btn">Apply</button>
                </div>
                <div class="postcode-input-group">
                    <label for="postcode-input">Centre Postcode:</label>
                    <div class="input-with-button">
                        <input type="text" id="postcode-input" placeholder="e.g. NG1 5FS">
                        <button id="apply-postcode-btn">Move</button>
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button id="download-csv-btn" disabled>Download CSV</button>
                <button id="download-xls-btn" disabled>Download XLS</button>
            </div>
            <button id="reset-btn">Reset Map</button>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="uk_cities_data.js"></script>
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Initialize map
                const map = L.map('map').setView([52.9548, -1.1581], 8);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);

                // Set UK bounds
                const ukBounds = L.latLngBounds(
                    [49.8, -8.6], // Southwest corner
                    [60.9, 1.8]   // Northeast corner
                );

                map.setMaxBounds(ukBounds);
                map.on('drag', function() {
                    map.panInsideBounds(ukBounds, { animate: false });
                });

                // Initialize layers
                const drawnItems = new L.FeatureGroup().addTo(map);
                let cityMarkers = new Map(); // Store markers for each city

                // Initialize drawing controls
                const drawControl = new L.Control.Draw({
                    position: 'topright',
                    draw: {
                        polygon: {
                            allowIntersection: false,
                            drawError: {
                                color: '#e1e100',
                                timeout: 1000
                            },
                            shapeOptions: {
                                color: '#2196F3'
                            },
                            showArea: true
                        },
                        rectangle: {
                            shapeOptions: {
                                color: '#2196F3'
                            }
                        },
                        circle: {
                            shapeOptions: {
                                color: '#2196F3'
                            },
                            showRadius: true,
                            metric: true
                        },
                        // Disable other drawing tools
                        polyline: false,
                        circlemarker: false,
                        marker: false
                    },
                    edit: {
                        featureGroup: drawnItems,
                        remove: true,
                        edit: {
                            selectedPathOptions: {
                                maintainColor: true,
                                opacity: 0.3
                            }
                        }
                    }
                });
                map.addControl(drawControl);

                // Add city markers if data is loaded
                let selectedCities = new Set();
                
                if (window.ukTownsAndCities && Array.isArray(window.ukTownsAndCities)) {
                    const cityMarkersLayer = L.layerGroup().addTo(map);
                    
                    // Create markers but don't add them to the map yet
                    window.ukTownsAndCities.forEach(city => {
                        const marker = L.marker([city.latitude, city.longitude])
                            .bindPopup(`<b>${city.name}</b><br>Population: ${city.population.toLocaleString()}<br>Phone Code: ${city.phoneCode}`);
                        cityMarkers.set(city.name, { marker, layer: cityMarkersLayer });
                    });

                    // Initialize empty city list
                    document.getElementById('city-list').innerHTML = '<div class="no-results">Draw a shape to select cities.</div>';
                } else {
                    throw new Error('Cities data not loaded');
                }

                // Function to check if a point is within a circle
                function isPointInCircle(point, circle) {
                    const center = circle.getLatLng();
                    const radius = circle.getRadius(); // in meters
                    const distance = point.distanceTo(center);
                    return distance <= radius;
                }

                // Function to filter cities within multiple shapes
                function filterCitiesInShapes() {
                    // Get all drawn layers
                    const layers = drawnItems.getLayers();
                    
                    // If no shapes, clear everything
                    if (layers.length === 0) {
                        cityMarkers.forEach(({ marker, layer }) => {
                            layer.removeLayer(marker);
                        });
                        document.getElementById('city-list').innerHTML = '<div class="no-results">Draw a shape to select cities.</div>';
                        document.getElementById('download-csv-btn').disabled = true;
                        document.getElementById('download-xls-btn').disabled = true;
                        return [];
                    }

                    // Filter cities that are within ANY of the drawn shapes
                    const filteredCities = window.ukTownsAndCities.filter(city => {
                        const cityLatLng = L.latLng(city.latitude, city.longitude);
                        
                        // Check if city is within any of the drawn shapes
                        return layers.some(layer => {
                            if (layer instanceof L.Circle) {
                                return isPointInCircle(cityLatLng, layer);
                            } else {
                                const bounds = layer.getBounds();
                                return bounds.contains(cityLatLng);
                            }
                        });
                    });

                    // Remove duplicate cities
                    const uniqueCities = Array.from(new Set(filteredCities.map(city => city.name)))
                        .map(name => filteredCities.find(city => city.name === name));

                    // Remove all markers first
                    cityMarkers.forEach(({ marker, layer }) => {
                        layer.removeLayer(marker);
                    });

                    // If city is in any shape, show its marker
                    uniqueCities.forEach(city => {
                        const { marker, layer: markerLayer } = cityMarkers.get(city.name);
                        markerLayer.addLayer(marker);
                    });

                    updateCityList(uniqueCities);
                    updateDownloadButtons();

                    return uniqueCities;
                }

                // Function to convert miles to meters
                function milesToMeters(miles) {
                    return miles * 1609.34;
                }

                // Function to convert meters to miles
                function metersToMiles(meters) {
                    return meters / 1609.34;
                }

                // Function to update circle diameter
                function updateCircleDiameter() {
                    const diameterControl = document.getElementById('diameter-control');
                    const circles = drawnItems.getLayers().filter(layer => layer instanceof L.Circle);
                    
                    if (circles.length > 0) {
                        diameterControl.style.display = 'block';
                        
                        // Update input value to show current diameter of last circle
                        const currentRadius = circles[circles.length - 1].getRadius();
                        document.getElementById('diameter-input').value = Math.round(metersToMiles(currentRadius * 2));
                    } else {
                        diameterControl.style.display = 'none';
                    }
                }

                // Function to fetch coordinates for a UK postcode
                async function getPostcodeCoordinates(postcode) {
                    try {
                        const response = await fetch(`https://api.postcodes.io/postcodes/${postcode}`);
                        if (!response.ok) {
                            throw new Error('Invalid postcode');
                        }
                        const data = await response.json();
                        return {
                            lat: data.result.latitude,
                            lng: data.result.longitude
                        };
                    } catch (error) {
                        throw new Error('Failed to find postcode location');
                    }
                }

                // Handle diameter input
                document.getElementById('apply-diameter-btn').addEventListener('click', function() {
                    const circles = drawnItems.getLayers().filter(layer => layer instanceof L.Circle);
                    if (circles.length > 0) {
                        const diameter = parseFloat(document.getElementById('diameter-input').value);
                        const radius = milesToMeters(diameter / 2);
                        
                        // Update all circles
                        circles.forEach(circle => {
                            circle.setRadius(radius);
                        });
                        
                        // Refilter cities based on new circle size
                        filterCitiesInShapes();
                    }
                });

                // Handle postcode input
                document.getElementById('apply-postcode-btn').addEventListener('click', async function() {
                    const postcode = document.getElementById('postcode-input').value.trim();
                    if (!postcode) {
                        alert('Please enter a postcode');
                        return;
                    }

                    try {
                        const coords = await getPostcodeCoordinates(postcode);
                        const circles = drawnItems.getLayers().filter(layer => layer instanceof L.Circle);
                        
                        if (circles.length > 0) {
                            // Get the current radius of the first circle
                            const radius = circles[0].getRadius();
                            
                            // Remove existing circles
                            circles.forEach(circle => drawnItems.removeLayer(circle));
                            
                            // Create new circle at postcode location
                            const newCircle = new L.Circle([coords.lat, coords.lng], {
                                radius: radius,
                                color: '#2196F3'
                            });
                            
                            drawnItems.addLayer(newCircle);
                            
                            // Center map on new location
                            map.setView([coords.lat, coords.lng], 10);
                            
                            // Update cities within the new circle
                            filterCitiesInShapes();
                        } else {
                            // If no circle exists, create one with default radius (15 miles)
                            const defaultRadius = milesToMeters(15);
                            const newCircle = new L.Circle([coords.lat, coords.lng], {
                                radius: defaultRadius,
                                color: '#2196F3'
                            });
                            
                            drawnItems.addLayer(newCircle);
                            map.setView([coords.lat, coords.lng], 10);
                            filterCitiesInShapes();
                            updateCircleDiameter();
                        }
                    } catch (error) {
                        alert(error.message);
                    }
                });

                // Add keypress event for postcode input
                document.getElementById('postcode-input').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById('apply-postcode-btn').click();
                    }
                });

                // Handle drawing events
                map.on(L.Draw.Event.CREATED, function(event) {
                    const layer = event.layer;
                    drawnItems.addLayer(layer);
                    filterCitiesInShapes();
                    updateCircleDiameter();
                });

                map.on(L.Draw.Event.DELETED, function() {
                    filterCitiesInShapes();
                    updateCircleDiameter();
                });

                map.on(L.Draw.Event.EDITED, function() {
                    filterCitiesInShapes();
                    updateCircleDiameter();
                });

                // Function to update city list display
                function updateCityList(cities) {
                    const cityList = document.getElementById('city-list');
                    const categorizedCities = window.categorizeCities(cities);
                    const categories = ['Major City', 'Large City', 'Medium City', 'Small City', 'Town'];
                    
                    cityList.innerHTML = categories.map(category => {
                        const citiesInCategory = categorizedCities.filter(city => city.category === category);
                        if (citiesInCategory.length === 0) return '';
                        
                        return `
                            <div class="category">
                                <h3>${category}</h3>
                                ${citiesInCategory.map(city => `
                                    <div class="city-item">
                                        ${city.name} (${city.phoneCode})
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }).join('');
                }

                // Function to update download buttons state
                function updateDownloadButtons() {
                    const hasSelection = selectedCities.size > 0;
                    document.getElementById('download-csv-btn').disabled = !hasSelection;
                    document.getElementById('download-xls-btn').disabled = !hasSelection;
                }

                // Handle download buttons
                document.getElementById('download-csv-btn').addEventListener('click', () => {
                    const csvContent = Array.from(selectedCities)
                        .map(city => `${city.name},${city.phoneCode},${city.population},${city.latitude},${city.longitude}`)
                        .join('\n');
                    
                    const blob = new Blob([`Name,Phone Code,Population,Latitude,Longitude\n${csvContent}`], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'selected_cities.csv';
                    a.click();
                    window.URL.revokeObjectURL(url);
                });

                document.getElementById('download-xls-btn').addEventListener('click', () => {
                    const data = Array.from(selectedCities).map(city => ({
                        Name: city.name,
                        'Phone Code': city.phoneCode,
                        Population: city.population,
                        Latitude: city.latitude,
                        Longitude: city.longitude
                    }));
                    
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Cities');
                    XLSX.writeFile(wb, 'selected_cities.xlsx');
                });

                // Handle reset button
                document.getElementById('reset-btn').addEventListener('click', () => {
                    drawnItems.clearLayers();
                    selectedCities.clear();
                    // Remove all markers
                    cityMarkers.forEach(({ marker, layer }) => {
                        layer.removeLayer(marker);
                    });
                    document.getElementById('city-list').innerHTML = '<div class="no-results">Draw a shape to select cities.</div>';
                    updateDownloadButtons();
                });

            } catch (error) {
                console.error('Map initialization error:', error);
                alert('Failed to initialize map. Please refresh the page.');
            }
        });
    </script>
</body>
</html>
