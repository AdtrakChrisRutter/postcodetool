<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Cities</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <a href="index.html" class="back-link">‚Üê Back to Tools</a>
            <img src="https://www.datocms-assets.com/19381/1652271729-adtrak-2.png" alt="Adtrak Logo" class="logo">
            <div id="city-list"></div>
            <div class="button-group">
                <button id="download-csv-btn" disabled>Download CSV</button>
                <button id="download-xls-btn" disabled>Download XLS</button>
            </div>
            <button id="reset-btn">Reset Map</button>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="uk_towns_cities.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([54.5, -2], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: ' OpenStreetMap contributors'
        }).addTo(map);

        // Initialize drawing controls
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Initialize drawing controls
        const drawControl = new L.Control.Draw({
            position: 'topright',
            draw: {
                polygon: {
                    allowIntersection: false,
                    drawError: {
                        color: '#e1e100',
                        timeout: 1000
                    },
                    shapeOptions: {
                        color: '#2196F3'
                    },
                    showArea: true
                },
                rectangle: {
                    shapeOptions: {
                        color: '#2196F3'
                    }
                },
                // Disable other drawing tools
                polyline: false,
                circle: false,
                circlemarker: false,
                marker: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);

        // Set UK bounds
        const ukBounds = L.latLngBounds(
            [49.8, -8.6], // Southwest corner
            [60.9, 1.8]   // Northeast corner
        );

        // Restrict map to UK
        map.setMaxBounds(ukBounds);
        map.on('drag', function() {
            map.panInsideBounds(ukBounds, { animate: false });
        });

        let currentFilteredCities = [];

        // Handle drawing events
        map.on(L.Draw.Event.CREATED, async function (event) {
            const layer = event.layer;
            drawnItems.addLayer(layer);
            
            // Show loading state
            const cityList = document.getElementById('city-list');
            cityList.innerHTML = '<div class="loading">Loading cities...</div>';
            document.getElementById('download-csv-btn').disabled = true;
            document.getElementById('download-xls-btn').disabled = true;

            // Filter cities within the drawn shape
            currentFilteredCities = ukTownsAndCities.filter(city => {
                const cityLatLng = L.latLng(city.latitude, city.longitude);
                return layer.getBounds().contains(cityLatLng);
            });

            // Display filtered cities
            if (currentFilteredCities.length > 0) {
                cityList.innerHTML = currentFilteredCities.map(city => 
                    `<div class="city-item">
                        ${city.name}
                        <small class="city-population">Pop: ${city.population.toLocaleString()}</small>
                        <span class="city-code">${city.areaCode}</span>
                    </div>`
                ).join('');
                
                // Enable download buttons
                document.getElementById('download-csv-btn').disabled = false;
                document.getElementById('download-xls-btn').disabled = false;
            } else {
                cityList.innerHTML = '<div class="no-results">No cities found in this area.</div>';
            }
        });

        // Handle shape deletion
        map.on(L.Draw.Event.DELETED, function (event) {
            if (drawnItems.getLayers().length === 0) {
                const cityList = document.getElementById('city-list');
                cityList.innerHTML = '';
                currentFilteredCities = [];
                document.getElementById('download-csv-btn').disabled = true;
                document.getElementById('download-xls-btn').disabled = true;
            }
        });

        // Reset map view
        document.getElementById('reset-btn').addEventListener('click', () => {
            drawnItems.clearLayers();
            map.setView([54.5, -2], 6);
            const cityList = document.getElementById('city-list');
            cityList.innerHTML = '';
            currentFilteredCities = [];
            document.getElementById('download-csv-btn').disabled = true;
            document.getElementById('download-xls-btn').disabled = true;
        });

        // Prevent map from zooming too far out
        map.setMinZoom(5);

        // Enable touch events for mobile devices
        if (L.Browser.touch) {
            L.DomEvent.disableClickPropagation(map._container);
        }

        // Download CSV function
        document.getElementById('download-csv-btn').addEventListener('click', function() {
            if (currentFilteredCities.length === 0) return;

            // Convert cities to CSV
            const csvContent = [
                'Name,Population,Category,Latitude,Longitude',
                ...currentFilteredCities.map(city => 
                    `${city.name},${city.population},${city.category},${city.latitude},${city.longitude}`
                )
            ].join('\n');

            // Create and download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'uk_cities.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Download XLS function
        document.getElementById('download-xls-btn').addEventListener('click', function() {
            if (currentFilteredCities.length === 0) return;

            // Prepare workbook
            const wb = XLSX.utils.book_new();
            const wsData = [
                ['Name', 'Population', 'Category', 'Latitude', 'Longitude'],
                ...currentFilteredCities.map(city => [
                    city.name, 
                    city.population, 
                    city.category, 
                    city.latitude, 
                    city.longitude
                ])
            ];

            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'UK Cities');

            // Generate and download Excel file
            XLSX.writeFile(wb, 'uk_cities.xlsx');
        });
    </script>
</body>
</html>
